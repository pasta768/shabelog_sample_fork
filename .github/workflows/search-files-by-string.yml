name: Search files by string

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  search:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(vars.SEARCH_FILES_BY_STRING_TIMEOUT_MINUTES || '10') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Search files containing target text
        id: search
        run: |
          python - <<'PY'
          import os
          import sys

          # 検索対象ディレクトリ
          target_directories = [
              "files",
          ]
          # 検索文字列
          search_texts = [
              "world",
              "linux",
              "ubuntu",
              "moon",
          ]

          if not target_directories:
              print("::error::No target directories configured")
              sys.exit(1)

          if not search_texts:
              print("::error::No search texts configured")
              sys.exit(1)
        
          # 検索対象ディレクトリの存在確認
          existing_directories = []
          for d in target_directories:
              if os.path.isdir(d):
                  existing_directories.append(d)
              else:
                  print(f"::warning::Directory not found and skipped: {d}")

          if not existing_directories:
              print("::error::No existing target directories to search")
              sys.exit(1)

          file_paths = []
          for base_dir in existing_directories:
              for root, _, files in os.walk(base_dir):
                  for name in files:
                      file_paths.append(os.path.join(root, name))

          search_texts_lower = {s: s.lower() for s in search_texts}
          matched_by_text = {s: [] for s in search_texts}
          all_matched = set()
          summary_body = []

          # ファイルを読み込み、検索文字列が含まれている場合はパスを記録
          for path in file_paths:
              try:
                  with open(path, "rb") as f:
                      # バイナリファイルは検索対象外
                      if b"\x00" in f.read(8192):
                          continue
                      f.seek(0)

                      remaining_texts = set(search_texts)
                      for raw_line in f:
                          line = raw_line.decode("utf-8", errors="ignore").lower()
                          matched_texts = [s for s in remaining_texts if search_texts_lower[s] in line]
                          for s in matched_texts:
                              matched_by_text[s].append(path)
                              all_matched.add(path)
                              remaining_texts.remove(s)

                          # 検索文字列が全て見つかったら、残りの行を読む必要はない
                          if not remaining_texts:
                              break
              except OSError:
                  continue

          for s in search_texts:
              matched = sorted(set(matched_by_text[s]))
              current_count = len(matched)

              summary_body.append(f"Search text: `{s}`\n")
              summary_body.append(f"Matched files: `{current_count}`\n\n")

              if current_count > 0:
                  summary_body.append("Matched file paths:\n```\n")
                  summary_body.append("\n".join(matched) + "\n")
                  summary_body.append("```\n\n")
                  all_matched.update(matched)
              else:
                  summary_body.append("No files contained this text.\n\n")

          total_match_count = len(all_matched)

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
              with open(github_output, "a", encoding="utf-8") as f:
                  f.write(f"match_count={total_match_count}\n")

          github_step_summary = os.environ.get("GITHUB_STEP_SUMMARY")
          if github_step_summary:
              with open(github_step_summary, "a", encoding="utf-8") as f:
                  f.write("### File Search Result\n")
                  f.write(f"- Target directories configured: `{len(target_directories)}`\n")
                  f.write(f"- Target directories searched: `{len(existing_directories)}`\n")
                  f.write(f"- Search texts configured: `{len(search_texts)}`\n")
                  f.write("- Case sensitive: `false`\n")
                  f.write(f"- Matched files (unique): `{total_match_count}`\n\n")
                  f.write("Target directories:\n```\n")
                  f.write("\n".join(existing_directories) + "\n")
                  f.write("```\n\n")
                  f.write("Search texts:\n```\n")
                  f.write("\n".join(search_texts) + "\n")
                  f.write("```\n\n")
                  f.write("".join(summary_body))
          PY

